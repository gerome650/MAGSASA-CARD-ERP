name: ğŸ§‘â€âš–ï¸ PR Governance Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches:
      - main
      - master
      - develop
      - "release/*"
      - "feature/*"

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ============================================================================
  # JOB 1: Spec Reference Validation
  # ============================================================================
  spec-reference-check:
    name: ğŸ“‹ Spec Reference Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Check for spec reference in PR body
        id: spec_check
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const prTitle = context.payload.pull_request.title || '';
            
            // Check for spec references (e.g., /specs/, specs/, Spec:, Specification:)
            const specPatterns = [
              /\/specs?\//i,
              /spec(?:ification)?:\s*\S+/i,
              /references?:\s*\S+/i,
              /design\s+doc:\s*\S+/i,
              /spec-\d+/i
            ];
            
            const hasSpecRef = specPatterns.some(pattern => 
              pattern.test(prBody) || pattern.test(prTitle)
            );
            
            // Exempt bot PRs, dependency updates, and docs-only changes
            const exemptPatterns = [
              /^\[bot\]/i,
              /^chore\(deps\)/i,
              /^docs:/i,
              /dependabot/i
            ];
            
            const isExempt = exemptPatterns.some(pattern => pattern.test(prTitle));
            
            if (!hasSpecRef && !isExempt) {
              core.setFailed('âŒ PR must include a spec reference in the body or title');
              core.summary
                .addHeading('âŒ Spec Reference Missing')
                .addRaw(`
                  This PR does not reference a specification document.
                  
                  **Required:** Add a reference to your spec in the PR description:
                  - Link to spec file: \`/specs/feature-name.md\`
                  - Spec ID: \`Spec: SPEC-123\`
                  - Design doc reference
                  
                  **Why?** Specs ensure features are properly designed before implementation.
                `)
                .write();
              return false;
            }
            
            console.log('âœ… Spec reference found or PR is exempt');
            return true;
      
      - name: ğŸ“Š Update check status
        if: always()
        run: |
          if [ "${{ steps.spec_check.outputs.result }}" == "false" ]; then
            echo "::warning::Spec reference check failed"
            exit 1
          fi

  # ============================================================================
  # JOB 2: Duplicate Test Detection
  # ============================================================================
  duplicate-test-check:
    name: ğŸ” Duplicate Test Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ” Scan for duplicate test names
        run: |
          echo "ğŸ” Scanning for duplicate test names..."
          
          # Find all test files
          TEST_FILES=$(find tests/ -name "test_*.py" -type f 2>/dev/null || echo "")
          
          if [ -z "$TEST_FILES" ]; then
            echo "âœ… No test files found to check"
            exit 0
          fi
          
          # Extract test function names
          DUPLICATES=$(grep -h "^def test_" $TEST_FILES | \
            sed 's/def \(test_[^(]*\).*/\1/' | \
            sort | uniq -d)
          
          if [ ! -z "$DUPLICATES" ]; then
            echo "âŒ Duplicate test names found:"
            echo "$DUPLICATES"
            echo ""
            echo "Please ensure all test names are unique across the test suite."
            exit 1
          fi
          
          echo "âœ… No duplicate test names found"
          
          # Check for duplicate test class names
          DUPLICATE_CLASSES=$(grep -h "^class Test" $TEST_FILES | \
            sed 's/class \(Test[^(:]*\).*/\1/' | \
            sort | uniq -d)
          
          if [ ! -z "$DUPLICATE_CLASSES" ]; then
            echo "âš ï¸  Warning: Duplicate test class names found:"
            echo "$DUPLICATE_CLASSES"
          fi

  # ============================================================================
  # JOB 3: Directory Structure Enforcement
  # ============================================================================
  directory-structure-check:
    name: ğŸ“ Directory Structure Enforcement
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ Validate directory structure
        run: |
          echo "ğŸ—ï¸ Validating project directory structure..."
          
          REQUIRED_DIRS=(
            "src"
            "tests"
            ".github/workflows"
            "scripts"
            "docs"
          )
          
          MISSING_DIRS=()
          
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "$dir" ]; then
              MISSING_DIRS+=("$dir")
            fi
          done
          
          if [ ${#MISSING_DIRS[@]} -gt 0 ]; then
            echo "âš ï¸  Warning: Missing recommended directories:"
            printf '%s\n' "${MISSING_DIRS[@]}"
          else
            echo "âœ… All recommended directories present"
          fi
          
          # Check for common anti-patterns
          if [ -d "temp" ] || [ -d "tmp" ] || [ -d "scratch" ]; then
            echo "âš ï¸  Warning: Temporary directories found (temp/tmp/scratch)"
            echo "Consider adding these to .gitignore"
          fi
          
          # Validate Python package structure
          if [ -d "src" ]; then
            if [ ! -f "src/__init__.py" ]; then
              echo "âš ï¸  Warning: src/__init__.py not found"
            fi
          fi
          
          echo "âœ… Directory structure validation complete"

  # ============================================================================
  # JOB 4: Secrets Scanning
  # ============================================================================
  secrets-scanning:
    name: ğŸ” Secrets Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” Scan for exposed secrets
        run: |
          echo "ğŸ” Scanning for exposed secrets..."
          
          # Patterns to detect potential secrets
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]{8,}"
            "api_key\s*=\s*['\"][^'\"]{20,}"
            "secret\s*=\s*['\"][^'\"]{20,}"
            "token\s*=\s*['\"][^'\"]{20,}"
            "aws_access_key_id"
            "AKIA[0-9A-Z]{16}"
            "ghp_[0-9a-zA-Z]{36}"
            "sk-[0-9a-zA-Z]{32,}"
          )
          
          FINDINGS=0
          
          for pattern in "${PATTERNS[@]}"; do
            # Search in Python, JS, YAML files (exclude common false positives)
            MATCHES=$(git diff origin/${{ github.base_ref }}...HEAD | \
              grep -i -E "^\+.*$pattern" | \
              grep -v "test_" | \
              grep -v "example" | \
              grep -v "template" | \
              grep -v "# pragma: allowlist secret" || true)
            
            if [ ! -z "$MATCHES" ]; then
              echo "âš ï¸  Potential secret found matching pattern: $pattern"
              FINDINGS=$((FINDINGS + 1))
            fi
          done
          
          if [ $FINDINGS -gt 0 ]; then
            echo ""
            echo "âŒ Found $FINDINGS potential secret(s) in the diff"
            echo "Please review and ensure no actual secrets are committed."
            echo "To bypass this check, add '# pragma: allowlist secret' comment"
            exit 1
          fi
          
          echo "âœ… No exposed secrets detected"

  # ============================================================================
  # JOB 5: Test Coverage Enforcement
  # ============================================================================
  coverage-enforcement:
    name: ğŸ“Š Test Coverage Enforcement
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: ğŸ“¦ Install dependencies
        run: |
          for i in 1 2 3; do 
            uv sync --dev && break || { 
              echo "Attempt $i failed, retrying..."; 
              sleep 5; 
            }
          done
      
      - name: ğŸ§ª Run tests with coverage
        run: |
          uv run pytest tests/ \
            --cov=src \
            --cov=packages \
            --cov-report=json \
            --cov-report=term \
            --cov-fail-under=80 \
            -v || true
      
      - name: ğŸ“Š Enforce coverage threshold
        run: |
          if [ -f coverage.json ]; then
            COVERAGE=$(python3 -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered'])")
            THRESHOLD=80
            
            echo "ğŸ“Š Coverage: ${COVERAGE}%"
            echo "ğŸ¯ Threshold: ${THRESHOLD}%"
            
            if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
              echo "âŒ Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
              exit 1
            fi
            
            echo "âœ… Coverage meets threshold"
          else
            echo "âš ï¸  Warning: coverage.json not found, skipping enforcement"
          fi
      
      - name: ğŸ’¾ Upload coverage report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: |
            coverage.json
            .coverage

  # ============================================================================
  # JOB 6: Linting (Ruff)
  # ============================================================================
  ruff-linting:
    name: ğŸ§¹ Ruff Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ Install ruff
        run: |
          pip install ruff
      
      - name: ğŸ§¹ Run ruff check
        run: |
          ruff check . \
            --output-format=github \
            --exclude "venv,dist,build,htmlcov,migrations,__pycache__" || {
            echo "âŒ Linting check failed"
            echo "Fix with: ruff check --fix ."
            exit 1
          }
      
      - name: ğŸ“Š Generate lint report
        if: always()
        run: |
          ruff check . \
            --output-format=json \
            --exclude "venv,dist,build,htmlcov,migrations,__pycache__" \
            > lint-results.json || true
          
          if [ -f lint-results.json ]; then
            VIOLATIONS=$(python3 -c "import sys, json; print(len(json.load(open('lint-results.json'))))" 2>/dev/null || echo "0")
            echo "LINT_VIOLATIONS=$VIOLATIONS" >> $GITHUB_ENV
            echo "ğŸ“Š Linting violations: $VIOLATIONS"
          fi
      
      - name: ğŸ’¾ Upload lint results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: lint-results
          path: lint-results.json

  # ============================================================================
  # JOB 7: Final Governance Summary
  # ============================================================================
  governance-summary:
    name: ğŸ“‹ Governance Summary
    runs-on: ubuntu-latest
    needs: 
      - spec-reference-check
      - duplicate-test-check
      - directory-structure-check
      - secrets-scanning
      - coverage-enforcement
      - ruff-linting
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“Š Generate summary report
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = {
              'spec-reference-check': '${{ needs.spec-reference-check.result }}',
              'duplicate-test-check': '${{ needs.duplicate-test-check.result }}',
              'directory-structure-check': '${{ needs.directory-structure-check.result }}',
              'secrets-scanning': '${{ needs.secrets-scanning.result }}',
              'coverage-enforcement': '${{ needs.coverage-enforcement.result }}',
              'ruff-linting': '${{ needs.ruff-linting.result }}'
            };
            
            const passed = Object.values(jobs).filter(r => r === 'success').length;
            const failed = Object.values(jobs).filter(r => r === 'failure').length;
            const total = Object.keys(jobs).length;
            
            const status = failed === 0 ? 'âœ… PASSED' : 'âŒ FAILED';
            const emoji = failed === 0 ? 'ğŸ‰' : 'âš ï¸';
            
            core.summary
              .addHeading(`${emoji} Governance Check Summary`)
              .addRaw(`\n**Status:** ${status}\n\n`)
              .addRaw(`**Results:** ${passed}/${total} checks passed\n\n`)
              .addHeading('Check Results', 3)
              .addTable([
                [{data: 'Check', header: true}, {data: 'Result', header: true}],
                ['ğŸ“‹ Spec Reference', jobs['spec-reference-check'] === 'success' ? 'âœ… Pass' : 'âŒ Fail'],
                ['ğŸ” Duplicate Tests', jobs['duplicate-test-check'] === 'success' ? 'âœ… Pass' : 'âŒ Fail'],
                ['ğŸ“ Directory Structure', jobs['directory-structure-check'] === 'success' ? 'âœ… Pass' : 'âŒ Fail'],
                ['ğŸ” Secrets Scanning', jobs['secrets-scanning'] === 'success' ? 'âœ… Pass' : 'âŒ Fail'],
                ['ğŸ“Š Coverage Enforcement', jobs['coverage-enforcement'] === 'success' ? 'âœ… Pass' : 'âŒ Fail'],
                ['ğŸ§¹ Ruff Linting', jobs['ruff-linting'] === 'success' ? 'âœ… Pass' : 'âŒ Fail']
              ])
              .write();
            
            if (failed > 0) {
              core.setFailed(`${failed} governance check(s) failed`);
            }
      
      - name: ğŸ¯ Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = {
              'spec-reference-check': '${{ needs.spec-reference-check.result }}',
              'duplicate-test-check': '${{ needs.duplicate-test-check.result }}',
              'directory-structure-check': '${{ needs.directory-structure-check.result }}',
              'secrets-scanning': '${{ needs.secrets-scanning.result }}',
              'coverage-enforcement': '${{ needs.coverage-enforcement.result }}',
              'ruff-linting': '${{ needs.ruff-linting.result }}'
            };
            
            const passed = Object.values(jobs).filter(r => r === 'success').length;
            const failed = Object.values(jobs).filter(r => r === 'failure').length;
            const total = Object.keys(jobs).length;
            
            const status = failed === 0 ? 'âœ… All checks passed!' : `âš ï¸ ${failed} check(s) failed`;
            
            const comment = `## ğŸ§‘â€âš–ï¸ Governance Check Results
            
            **Status:** ${status}
            **Score:** ${passed}/${total} checks passed
            
            ### Check Details
            
            | Check | Result |
            |-------|--------|
            | ğŸ“‹ Spec Reference | ${jobs['spec-reference-check'] === 'success' ? 'âœ…' : 'âŒ'} |
            | ğŸ” Duplicate Tests | ${jobs['duplicate-test-check'] === 'success' ? 'âœ…' : 'âŒ'} |
            | ğŸ“ Directory Structure | ${jobs['directory-structure-check'] === 'success' ? 'âœ…' : 'âŒ'} |
            | ğŸ” Secrets Scanning | ${jobs['secrets-scanning'] === 'success' ? 'âœ…' : 'âŒ'} |
            | ğŸ“Š Coverage Enforcement | ${jobs['coverage-enforcement'] === 'success' ? 'âœ…' : 'âŒ'} |
            | ğŸ§¹ Ruff Linting | ${jobs['ruff-linting'] === 'success' ? 'âœ…' : 'âŒ'} |
            
            ${failed > 0 ? '\nâš ï¸ **Action Required:** Please fix the failing checks before merging.' : '\nğŸ‰ **Great job!** All governance checks passed.'}
            
            ---
            *Automated governance check â€¢ [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================================================
  # JOB 8: Render Metrics Collector
  # ============================================================================
  render-metrics-collector:
    name: ğŸ“Š Render Metrics Collector
    runs-on: ubuntu-latest
    needs: [governance-summary]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Fetch Render Metrics
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "ğŸ” Fetching Render metrics..."
          
          # Check if secrets are configured
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "âš ï¸ RENDER_API_KEY or RENDER_SERVICE_ID not configured"
            echo "Skipping Render metrics collection"
            echo '{"status": "skipped", "reason": "secrets not configured"}' > render_metrics.json
            exit 0
          fi
          
          # Fetch metrics from Render API
          HTTP_CODE=$(curl -s -w "%{http_code}" -o render_metrics.json \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/metrics")
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ Failed to fetch metrics (HTTP $HTTP_CODE)"
            echo '{"status": "error", "http_code": '$HTTP_CODE'}' > render_metrics.json
            exit 0
          fi
          
          if [ ! -s render_metrics.json ]; then
            echo "âŒ No metrics found â€” check service ID or API key"
            echo '{"status": "error", "reason": "empty response"}' > render_metrics.json
            exit 0
          fi
          
          echo "âœ… Metrics fetched successfully"
          jq '.' render_metrics.json || echo "âš ï¸ Could not pretty-print metrics"
      
      - name: ğŸ“Š Inject Render Metrics Summary
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "render-metrics"
          message: |
            ## ğŸ“Š Render Metrics Summary
            
            ```json
            $(cat render_metrics.json)
            ```
            
            ğŸ§  *Live data pulled from Render API during PR validation*
            
            ---
            
            ### Thresholds & Status
            
            | Metric | Status | Threshold | Live Value |
            |--------|--------|------------|-------------|
            | Uptime | â³ | > 99% | *See JSON above* |
            | Latency | â³ | < 2500ms | *See JSON above* |
            | Drift | â³ | < 2% | *See JSON above* |
            
            > ğŸ“š **Spec Reference:** `/specs/render_integration.md`
            > ğŸ›¡ï¸ **Guardrails:** `/specs/observer_guardrails.yaml`


