name: Resilience Gate (main)

on:
  workflow_dispatch: {}         # shows the "Run workflow" button on main
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  gate:
    name: OPA Resilience Gate
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools (jq, Python deps)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          python -m pip install --upgrade pip
          pip install yamllint jsonschema

      - name: Install OPA (v0.68.0)
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.68.0/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/opa
          opa version

      - name: Lint & validate configs
        run: |
          yamllint configs
          python scripts/validate_configs.py

      - name: Run OPA policy unit tests
        run: |
          opa test platform/gatekeeper/policies -v

      - name: Enforce resilience policy
        run: |
          echo '{"chaos_failed": false, "slo_regressions": 0}' > /tmp/input.json
          opa eval -f json -i /tmp/input.json -d platform/gatekeeper/policies 'data.resilience.deny' \
            | jq -r '.result[0].expressions[0].value' > /tmp/deny.json
          echo "OPA deny set:" && cat /tmp/deny.json
          if [ "$(jq 'length' /tmp/deny.json)" -gt 0 ]; then
            echo "‚ùå Resilience policy denies this change"
            exit 1
          fi
